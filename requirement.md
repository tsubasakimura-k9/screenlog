# ScreenLog 設計ドキュメント

## 1. 概要

ScreenLogは、macOS上で動作する作業ログ自動生成ツールである。スクリーンショットを定期的に取得し、ローカルOCRでテキスト化して保存する。蓄積されたログをAIに読み取らせることで、「何時から何時に何をしていたか」を自動的にまとめることができる。

---

## 2. なぜこのツールが必要か（Purpose）

### 2.1 解決したい課題

- **作業ログを取るのが面倒**：手動で「何をやったか」を記録するのは継続が難しい
- **振り返りができない**：一日の終わりに「今日何してたっけ？」となることが多い
- **時間の使い方が見えない**：どの作業にどれだけ時間を使ったか把握できていない

### 2.2 このツールで実現すること

- **完全自動の作業記録**：ユーザーは何も意識せず、バックグラウンドで作業が記録される
- **時系列での作業把握**：「9:00-10:30はドキュメント作成、10:30-12:00はコーディング」のように把握できる
- **AIによる要約**：蓄積されたログをAIに渡すだけで、人間が読みやすい形式にまとめてもらえる

### 2.3 設計思想

- **ローカル完結**：プライバシーを考慮し、OCR処理はmacOS標準機能でローカル実行する（外部APIを使わない）
- **シンプルさ優先**：最小限の構成で動作し、依存関係を少なくする
- **AI連携前提**：ログのフォーマットはAIが読み取りやすい構造にする

---

## 3. 機能要件（Functional Requirements）

### 3.1 スクリーンキャプチャ機能

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| F-CAP-01 | 定期的なスクリーンショット取得 | 1分間隔でスクリーンショットを取得する |
| F-CAP-02 | アクティブウィンドウ情報の取得 | 現在アクティブなウィンドウのアプリケーション名・ウィンドウタイトルを取得する |
| F-CAP-03 | スクリーンショットの一時保存 | OCR処理のために一時的に画像ファイルを保存する |
| F-CAP-04 | スクリーンショットの自動削除 | OCR処理完了後、画像ファイルを削除してストレージを圧迫しない |

### 3.2 OCR機能

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| F-OCR-01 | ローカルOCR処理 | macOS Vision Frameworkを使用してテキスト抽出する |
| F-OCR-02 | 日本語・英語対応 | 日本語と英語のテキストを認識できる |
| F-OCR-03 | エラーハンドリング | OCRに失敗した場合でもプロセスを停止せず、空のテキストとして記録する |

### 3.3 ログ保存機能

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| F-LOG-01 | JSONL形式での保存 | 1キャプチャ1行のJSONL形式で保存する |
| F-LOG-02 | 日付別ファイル管理 | 1日1ファイルとして管理する（例：2024-12-23.jsonl） |
| F-LOG-03 | 追記モード | 既存ファイルに追記していく形式とする |
| F-LOG-04 | タイムスタンプ記録 | 各ログエントリにISO 8601形式のタイムスタンプを含める |

### 3.4 プロセス管理機能

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| F-PROC-01 | バックグラウンド実行 | ユーザーの作業を妨げずバックグラウンドで動作する |
| F-PROC-02 | 開始・停止コマンド | CLIから簡単に開始・停止できる |
| F-PROC-03 | 自動起動（オプション） | macOS起動時に自動で開始できる設定を用意する |

---

## 4. 非機能要件（Non-Functional Requirements）

### 4.1 パフォーマンス

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| NF-PERF-01 | 低リソース消費 | CPU使用率を最小限に抑え、通常作業に影響を与えない |
| NF-PERF-02 | 高速なOCR処理 | 1分以内に次のキャプチャまでにOCR処理を完了する |

### 4.2 プライバシー・セキュリティ

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| NF-SEC-01 | ローカル処理 | スクリーンショット・OCR処理は全てローカルで完結する |
| NF-SEC-02 | 外部送信なし | キャプチャデータを外部サーバーに送信しない |
| NF-SEC-03 | ログの保存場所 | ログファイルはユーザーのホームディレクトリ配下に保存する |

### 4.3 信頼性

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| NF-REL-01 | クラッシュ耐性 | エラーが発生しても自動で復帰し、ログ取得を継続する |
| NF-REL-02 | データ整合性 | ログファイルが破損しないよう、書き込みは安全に行う |

---

## 5. データ構造

### 5.1 ログエントリ（1レコード）

```json
{
  "timestamp": "2024-12-23T14:35:00+09:00",
  "active_app": "Visual Studio Code",
  "window_title": "main.py - MyProject",
  "ocr_text": "def process_screenshot():\n    # スクリーンショットを処理する\n    capture = take_screenshot()\n    ...",
  "ocr_confidence": 0.85
}
```

### 5.2 フィールド定義

| フィールド名 | 型 | 必須 | 説明 |
|-------------|-----|------|------|
| timestamp | string (ISO 8601) | ✓ | キャプチャ取得時刻 |
| active_app | string | ✓ | アクティブなアプリケーション名 |
| window_title | string | ✓ | アクティブウィンドウのタイトル |
| ocr_text | string | ✓ | OCRで抽出されたテキスト（抽出できなかった場合は空文字） |
| ocr_confidence | number | - | OCRの信頼度スコア（0.0〜1.0、取得可能な場合） |

### 5.3 ファイル構成

```
~/ScreenLog/
├── logs/
│   ├── 2024-12-21.jsonl
│   ├── 2024-12-22.jsonl
│   └── 2024-12-23.jsonl
├── tmp/                      # 一時ファイル（自動削除）
└── config.json              # 設定ファイル（オプション）
```

---

## 6. 技術構成

### 6.1 使用技術

| コンポーネント | 技術 | 理由 |
|---------------|------|------|
| 言語 | Python 3.x | シンプルで読みやすく、macOS標準でインストール済み |
| スクリーンキャプチャ | screencapture（macOS標準コマンド） | 追加インストール不要、高速 |
| アクティブウィンドウ取得 | AppleScript（osascript経由） | macOS標準機能で信頼性が高い |
| OCR | Vision Framework（pyobjc経由） | ローカル処理、日本語対応、無料 |
| スケジューリング | Python標準（time.sleep or schedule） | シンプルな実装で十分 |

### 6.2 コンポーネント構成

```
┌─────────────────────────────────────────────────────────┐
│                      Main Loop                          │
│                   (1分間隔で実行)                        │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│              Screen Capture Module                      │
│  - screencaptureコマンドで画面全体をキャプチャ           │
│  - 一時ファイルとして保存                               │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│            Active Window Module                         │
│  - AppleScriptでアクティブアプリ名を取得                 │
│  - AppleScriptでウィンドウタイトルを取得                 │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  OCR Module                             │
│  - Vision Frameworkでテキスト抽出                       │
│  - 日本語・英語認識                                     │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                 Logger Module                           │
│  - JSONLフォーマットで整形                              │
│  - 日付別ファイルに追記                                 │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                Cleanup Module                           │
│  - 一時画像ファイルを削除                               │
└─────────────────────────────────────────────────────────┘
```

---

## 7. 処理フロー

### 7.1 メインループ

```
1. 開始
2. ループ開始（1分間隔）
   2.1. 現在時刻を取得
   2.2. スクリーンショットを撮影し、一時ファイルに保存
   2.3. アクティブウィンドウ情報を取得
   2.4. 一時ファイルからOCRでテキスト抽出
   2.5. ログエントリを作成
   2.6. JSONLファイルに追記
   2.7. 一時ファイルを削除
   2.8. 1分待機
3. ループ終了（停止シグナル受信時）
```

### 7.2 エラーハンドリング方針

| エラー種別 | 対処 |
|-----------|------|
| スクリーンショット取得失敗 | ログに記録し、次のサイクルへスキップ |
| アクティブウィンドウ取得失敗 | "Unknown"として記録し、処理を継続 |
| OCR処理失敗 | ocr_textを空文字として記録し、処理を継続 |
| ファイル書き込み失敗 | エラーログを出力し、リトライ後に次のサイクルへ |

---

## 8. AIによる作業まとめ（後処理）

### 8.1 想定する使い方

ログファイルをAI（Claude等）に渡して、以下のようなプロンプトで要約させる：

```
以下は今日の作業ログです。JSONLファイルの各行がスクリーンショットから取得した情報です。
これを読み取って、何時から何時に何をしていたかを時系列でまとめてください。
細かいエントリは適宜集約し、作業の切り替わりがわかるようにしてください。

---
[JSONLファイルの内容をここに貼り付け]
```

### 8.2 期待する出力形式

```
## 2024年12月23日の作業ログ

- 09:00〜10:30：ドキュメント作成（Notion）
  - プロジェクト仕様書の更新
- 10:30〜10:45：メール確認（Gmail）
- 10:45〜12:30：コーディング（VS Code）
  - main.pyの実装
  - テストコードの追加
- 12:30〜13:30：昼休憩（ログなし）
- 13:30〜15:00：ミーティング（Zoom）
  - チーム定例
- 15:00〜17:00：コーディング（VS Code）
  - バグ修正
  - コードレビュー対応
```

---

## 9. 実装時の注意点

### 9.1 macOS権限

以下の権限が必要になる。初回実行時にユーザーに許可を求めるダイアログが表示される：

- **画面収録（Screen Recording）**：スクリーンショット取得のため
- **アクセシビリティ（Accessibility）**：アクティブウィンドウ情報取得のため

### 9.2 依存ライブラリ

```
pyobjc-framework-Vision  # Vision Framework利用のため
pyobjc-framework-Quartz  # 画面情報取得のため（必要に応じて）
```

### 9.3 テスト観点

- [ ] 1分間隔で正しくキャプチャされるか
- [ ] 複数ディスプレイ環境で動作するか
- [ ] 日本語テキストが正しくOCRされるか
- [ ] 日付をまたいだときにファイルが切り替わるか
- [ ] 長時間稼働でメモリリークがないか
- [ ] スリープ復帰後に正常動作するか

---

## 10. 将来の拡張可能性（スコープ外）

以下は本設計のスコープ外だが、将来的に追加を検討できる機能：

- **除外アプリ設定**：特定のアプリ（パスワードマネージャー等）はキャプチャしない
- **キャプチャ間隔の設定**：1分以外の間隔を設定可能に
- **自動要約**：ログを自動でAIに送信して要約を生成
- **Webダッシュボード**：蓄積されたログを可視化
- **タグ付け**：作業カテゴリの自動分類

---

## 11. 成果物

本設計に基づき、以下のファイル構成で実装する：

```
ScreenLog/
├── README.md              # 使い方・セットアップ手順
├── requirements.txt       # 依存ライブラリ
├── screenlog/
│   ├── __init__.py
│   ├── main.py           # エントリーポイント・メインループ
│   ├── capture.py        # スクリーンキャプチャモジュール
│   ├── window.py         # アクティブウィンドウ取得モジュール
│   ├── ocr.py            # OCRモジュール
│   └── logger.py         # ログ保存モジュール
└── scripts/
    └── start.sh          # 起動スクリプト
```